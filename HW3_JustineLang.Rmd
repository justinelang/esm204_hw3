---
title: "ESM 204 Homework 3"
author: "Justine Lang"
date: "2023-05-18"
output: 
  html_document: 
    code_folding: hide
---

```{r setup, include=FALSE, echo = TRUE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(janitor)
library(here)
library(broom)
library(car)
library(pracma)
```

```{r}
### Read in data

ev_dat <- read_csv(here("HW3_data.csv")) %>% 
  clean_names() %>% 
  rename("price" = "price_dollars",
         "dac" = "q_dac",
         "non_dac" = "q_non_dac")

ev_long <- ev_dat %>% 
  pivot_longer(cols = dac:non_dac, names_to = "community", values_to = "quantity")
```


## Question 1

The data set HW3 data.csv provides price (in $) and quantity (in number of EVs) estimates
of demand per year for both DAC and non-DAC groups. Run linear regressions (with an
intercept) to estimate the demand curves for DAC and non-DAC consumers. What are 2-3
reasons you can think that may explain the differences in demand you estimate?

```{r}
### Run linear regressions

dac_lm <- lm(price ~ dac, data = ev_dat)
dac_coeff <- dac_lm$coefficients

non_dac_lm <- lm(price ~ non_dac, data = ev_dat)
non_dac_coeff <- non_dac_lm$coefficients
```

```{r}
### Write demand functions

### P = a + bQ

dac_demand <- function(Q){
  P = 116854.84 - 6.61*Q
  return(P)
}

nondac_demand <- function(Q){
  P =  158034.28 - 2.73*Q
  return(P)
}

### Q = (P - a)/b

dac_demand_q <- function(P){
  Q = (116854.84 - P)/6.61
  return(Q)
}

nondac_demand_q <- function(P){
  Q = (158034.28 - P)/2.73
  return(Q)
}
```

**DAC Demand:** $P = 116,854.84 - 6.61*Q$

**Non-DAC Demand:** $P =  158,034.28 - 2.73*Q$

Write 2-3 reasons here.



## Question 2

One kilogram (kg) of lithium is estimated to cause $300 dollars worth of damage in health costs
to local communities living near mines. Each EV requires a lithium ion battery containing
63kg of lithium. Assuming there are no other externalities caused by EV production, what is
the marginal externality cost per EV produced?

```{r}
MEC <- 18900
```

$300/kg * 63kg/EV = 
$18,900/EV

$MEC = 18,900$



## Question 3

What is the aggregate annual demand curve for EVs? What is the supply curve for EVs?
What is the “benefit” to consumers under the status quo? What is the “benefit” to producers
under the status quo? What is the environmental cost under the status quo?

```{r}
### Write aggregate demand functions

agg_demand <- function(P) {
  if (P > 116854.84) {
  Q = nondac_demand_q(P)
  }
  if(P <= 116854.84) {
   Q = dac_demand_q(P) + nondac_demand_q(P)
  }
  return(Q)
}

simp_agg_demand <- function(P) {
  Q = dac_demand_q(P) + nondac_demand_q(P)
  return(Q)
}
```

```{r}
### Supply = 0 + mQ
### EV price without intervention is $50,000 per EV

# agg_demand(50000) ### Q = 49687.19

# 50000/agg_demand(50000) ### 1.006296

supply <- function(Q) {
  P = 0 + 1.006296*Q
  return(P)
}
```

```{r}
### Surplus

cs_fun <- function(a, Q) {
  P = 1/2*(a - 50000)*Q
  return(P)
}

dac_cs <- cs_fun(116854.84, dac_demand_q(50000))
nondac_cs <- cs_fun(158034.28, nondac_demand_q(50000))
cs <- cs_fun(116854.84, dac_demand_q(50000)) + cs_fun(158034.28, nondac_demand_q(50000))

### DAC cs: 338091500
### Non-DAC cs: 2137620083
### total cs: 2475711583

ps_fun <- function(Q) {
  P = 1/2*50000*Q
  return(P)
}

# ps_fun(agg_demand(50000)) ### 1242179825
```

```{r}
### EC = Qagg * MEC

### Should have done this sooner
pstar <- 50000
qstar <- agg_demand(50000)

ec <- qstar*MEC
# ec ### 939087948
```


```{r}
### Visualize demand curves - tidy up graph

ggplot(data = ev_long, aes(x = quantity, y = price, color = community)) + 
  geom_point() + 
  ylim(0, 190000) +
  xlim(0, 90000) +
  stat_function(fun = function(Q) dac_demand(Q)) +
  stat_function(fun = function(Q) nondac_demand(Q)) + 
  stat_function(fun = function(Q) supply(Q)) +
  geom_hline(yintercept = 18900) +
  theme_minimal() 
```

**Aggregate Demand:** When P > 116,854.84, the aggregate demand curve is $P =  158,034.28 - 2.73*Q$.
When P ≤ 116,854.84, the aggregate demand curve would be around $P = 145,997.96 - Q/0.5175$.

**Supply:** $P = 1.006*Q$

**CS:** $2,475,711,583 

**PS:** $1,242,179,825

**EC:** $939,087,948


## Question 4

How is the current consumer benefit divided between DAC and non-DAC consumers?

**DAC CS:** $338,091,500, or 14% of the consumer benefit. 

**Non-DAC CS:** $2,137,620,083, or 86% of the consumer benefit. 

```{r}
dac_perc <- dac_cs/cs
nondac_perc <- nondac_cs/cs

# dac_perc ### 0.1365634
# nondac_perc ### 0.8634366
```



## Question 5

Derive the optimal EV tax (in $ per vehicle) to internalize the lithium mining externality.
Noting that recent research has shown that DACs are far more likely to contain mining activity,
assume that the mining externality is borne entirely by the DAC group. What would be the
effects of this tax on:

**(a) The amount of EVs produced and consumed**

```{r}
### New socially optimal supply curve with MEC

msc <- function(Q) {
  P = MEC + 1.006296*Q
  return(P)
}

msc_q <- function(P) {
  Q = (P - MEC)/1.006296
  return(Q)
}
```

The optimal tax is the MEC at the socially optimal Q. Since the MEC is constant, the optimal tax is $18,900.

```{r}
agg_demand_p <- function(Q){
  P = (75566.5 - Q)/0.5175
  return(P)
}


F3 <- function(Q){
  z <- agg_demand_p(Q) - msc(Q)
  return(z)
  }
```

```{r}
# fzero(F3, c(0,1000))$x

qstar_so <- 43258.5

# agg_demand(50000) 
```

The socially optimal quantity is around 43,258.5 EVs, which could be rounded down to 43,258. This is less than the previous Qstar of 49,687 EVs. 


**(b) The price of EVs**

```{r}
pstar_so <- msc(qstar_so) ### 62430.86
```

The socially optimal price is around $62,430.86, 
which is higher than the previous Pstar of $50,000. 


**(c) Overall welfare of non-DAC consumers**

```{r}
### Writing more general CS and PS functions

cs_fun2 <- function(a, Popt, Q) {
  P = 1/2*(a - Popt)*Q
  return(P)
}

ps_fun2 <- function(Popt, Q) {
  P = 1/2*Popt*Q
  return(P)
}
```

```{r}
# cs_fun2(158034.28, pstar_so, nondac_demand_q(pstar_so)) ### 1673995380
```

Non-DAC CS: $1,673,995,380, 
which is lower than the previous CS of $2,137,620,083. 


**(d) Overall welfare of DAC consumers**

```{r}
# cs_fun2(116854.84, pstar_so, dac_demand_q(pstar_so)) ### 224052200

# 224052200 - 817484583 ### -593432383
```

DAC CS: $224,052,200, 
which is lower than the previous CS of $338,091,500. If you subtract all of the environmental costs
from that number, the overall welfare is a loss of -$593,432,383. 


**(e) EV producers**

```{r}
# ps_fun2(pstar_so, agg_demand(pstar_so)) ### 1350165658
```

PS: $1,350,165,658,
which is higher than the previous PS of $1,242,179,825. 


**(f) Total environmental damage**

```{r}
ec_t <- agg_demand(pstar_so) * MEC ### 817484583
```

Total environmental damage: $817,484,583, 
which is lower than the previous $939,087,948


**(g) Total tax revenue generated**

Total tax revenue is the same as total environmental damage: $817,484,583. 



## Question 6

Now, assume that all revenue from the EV tax will be redistributed to the consumers in
proportion to their pre-tax consumption. For example, if 80% of the EVs were consumed
by non-DAC consumers, then they get 80% of the tax revenue. Additionally, consider that
emerging scientific evidence suggests the true environmental damages from lithium mining may
be much higher than $300. 
For a range of values of external costs per kg of lithium ($350,
$400, 
$450, 
and $500 per kg), calculate the effects of an EV tax on:
(a) Overall welfare of non-DAC consumers
(b) Overall welfare of DAC consumers
(c) EV producers


## Question 7

Now, consider the fact that the purchase of EVs not only leads to lithium mining, but also helps
mitigate climate change by replacing gasoline cars. Suppose that climate change damages fall
mostly outside California, to a lesser extent on DAC consumers, and not at all on non-DAC
consumers. Qualitatively answer the following (in 1-3 sentences each):
(a) How does the presence of climate change damages from gasoline cars affect the optimal
EV tax in California?
(b) Assuming tax revenue does not get returned to consumers, are non-DAC consumers more
or less likely to support this new tax, relative to the tax that only accounts for the mining
externality? Why?
(c) Assuming tax revenue does not get returned to consumers, are DAC consumers more or
less likely to support this new tax, relative to the tax that only accounts for the mining
externality? Why?







### Notes

Slope = 50,000/Q_agg(50,000)

P = 0 + 50,000/Q_agg(50,000)

Don't worry about the kink in the agg curve. Just use triangle formula. Write function. Use demand function to calculate base of the triangle. 

Producer surplus simpler. 

Total environmental damage = externality per car x total cars. 

EV tax: the MEC at Qso; in this case, tax just equals MEC

Equate new supply curve (MSC) to aggregate demand curve. P = mQ + t; Q = P-t/m -> supply(p,t); Q should = Qagg. Use uniroot to find Pt*. Plug Pstar back into equation to find Qstar. 

Would work to find Pstar or Qstar first, but might be best to find Pstar first. 

Assume the mining externality is borne entirely by the DAC group. 

Health cost = Qagg(Pt) x MEC

The results should indicate that the tax doesn't do much for the disadvantaged group. 

See tax on sellers graph. 

stargazer

Tax revenue = Qstar x t(MEC); calculate the redistribution four different times.

Just answer question 7 qualitatively. 































